#!/bin/bash
# Pre-deploy hook - sets up directories and ensures database is healthy before deploying app
# Skipped during initial setup when database doesn't exist yet

set -e

# Use environment variables directly (set by env-cmd or shell)
ROOT_PASS="${MYSQL_ROOT_PASSWORD:-}"
PRIMARY_HOST="${PRIMARY_HOST:-192.168.0.1}"
SSH_USER="${SSH_USER:-root}"

echo "=== Pre-deploy: Setting up directories ==="

# Create and fix permissions for mounted volumes (frappe user has uid 1000)
ssh ${SSH_USER}@$PRIMARY_HOST "mkdir -p \$HOME/erpnext/sites \$HOME/erpnext/logs && chown -R 1000:1000 \$HOME/erpnext"
echo "✓ Directories ready on primary host"

echo "=== Pre-deploy: Checking database health ==="

# Check if database container exists
if ! ssh -o ConnectTimeout=5 ${SSH_USER}@$PRIMARY_HOST "docker ps -q -f name=erpnext-db$" 2>/dev/null | grep -q .; then
    echo "⚠ No database container found - skipping checks (initial setup)"
    echo "=== Pre-deploy checks skipped (first deployment) ==="
    exit 0
fi

echo "Checking database..."
if ssh ${SSH_USER}@$PRIMARY_HOST "docker exec erpnext-db mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
    echo "✓ Database is healthy"
else
    echo "✗ Database is not accessible"
    exit 1
fi

echo "=== Pre-deploy checks passed ==="
