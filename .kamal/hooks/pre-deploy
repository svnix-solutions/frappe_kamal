#!/bin/bash
# Pre-deploy hook - ensures database replication is healthy before deploying app
# Skipped during initial setup when databases don't exist yet

set -e

source .kamal/secrets 2>/dev/null || true

ROOT_PASS="${MYSQL_ROOT_PASSWORD}"
MASTER_HOST="${KAMAL_MASTER_HOST:-192.168.0.1}"
SLAVE_HOST="${KAMAL_SLAVE_HOST:-192.168.0.2}"

echo "=== Pre-deploy: Checking database health ==="

# Check if master container exists first
if ! ssh -o ConnectTimeout=5 root@$MASTER_HOST "docker ps -q -f name=erpnext-db-master" 2>/dev/null | grep -q .; then
    echo "⚠ Master database container not found - skipping checks (initial setup)"
    echo "=== Pre-deploy checks skipped (first deployment) ==="
    exit 0
fi

# Check if master is accessible
echo "Checking master database..."
if ssh root@$MASTER_HOST "docker exec erpnext-db-master mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
    echo "✓ Master database is healthy"
else
    echo "✗ Master database is not accessible"
    exit 1
fi

# Check if slave container exists
if ! ssh -o ConnectTimeout=5 root@$SLAVE_HOST "docker ps -q -f name=erpnext-db-slave" 2>/dev/null | grep -q .; then
    echo "⚠ Slave database container not found - skipping slave checks"
    echo "=== Pre-deploy checks passed ==="
    exit 0
fi

# Check if slave is accessible and replicating
echo "Checking slave database..."
if ssh root@$SLAVE_HOST "docker exec erpnext-db-slave mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
    echo "✓ Slave database is accessible"

    # Check replication status
    SLAVE_IO=$(ssh root@$SLAVE_HOST "docker exec erpnext-db-slave mariadb -u root -p${ROOT_PASS} -N -e \"SHOW SLAVE STATUS\\G\" | grep 'Slave_IO_Running:' | awk '{print \$2}'" 2>/dev/null || echo "No")
    SLAVE_SQL=$(ssh root@$SLAVE_HOST "docker exec erpnext-db-slave mariadb -u root -p${ROOT_PASS} -N -e \"SHOW SLAVE STATUS\\G\" | grep 'Slave_SQL_Running:' | awk '{print \$2}'" 2>/dev/null || echo "No")

    if [[ "$SLAVE_IO" == "Yes" && "$SLAVE_SQL" == "Yes" ]]; then
        echo "✓ Replication is running"
    else
        echo "⚠ Replication is not running (IO: $SLAVE_IO, SQL: $SLAVE_SQL)"
        echo "  This is a warning - deployment will continue"
    fi
else
    echo "⚠ Slave database is not accessible - continuing without slave check"
fi

echo "=== Pre-deploy checks passed ==="
