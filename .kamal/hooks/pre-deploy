#!/bin/bash
# Pre-deploy hook - ensures database is healthy before deploying app
# Supports both single-server (deploy.shared.yml) and multi-server (deploy.yml) configurations
# Skipped during initial setup when databases don't exist yet

set -e

# Use environment variables directly (set by env-cmd or shell)
ROOT_PASS="${MYSQL_ROOT_PASSWORD:-}"
PRIMARY_HOST="${PRIMARY_HOST:-192.168.0.1}"
REPLICA_HOST="${REPLICA_HOST:-$PRIMARY_HOST}"
SSH_USER="${SSH_USER:-root}"

# echo "=== Pre-deploy: Setting up directories ==="

# # Create and fix permissions for mounted volumes (frappe user has uid 1000)
# ssh ${SSH_USER}@$PRIMARY_HOST "mkdir -p /home/$SSH_USER/erpnext/sites /home/$SSH_USER/erpnext/logs && chown -R 1000:1000 /home/$SSH_USER/erpnext"
# echo "✓ Directories ready on primary host"

# # For multi-server, also setup on replica
# if [[ "$REPLICA_HOST" != "$PRIMARY_HOST" ]]; then
#     ssh ${SSH_USER}@$REPLICA_HOST "mkdir -p /home/$SSH_USER/erpnext/sites /home/$SSH_USER/erpnext/logs && chown -R 1000:1000 /home/$SSH_USER/erpnext" 2>/dev/null || true
#     echo "✓ Directories ready on replica host"
# fi

echo "=== Pre-deploy: Checking database health ==="

# Detect deployment mode by checking which container exists
# Single-server mode: erpnext-db
# Multi-server mode: erpnext-db-master / erpnext-db-slave

# Check for single-server mode first (erpnext-db)
if ssh -o ConnectTimeout=5 ${SSH_USER}@$PRIMARY_HOST "docker ps -q -f name=erpnext-db$" 2>/dev/null | grep -q .; then
    echo "Detected single-server deployment mode"

    echo "Checking database..."
    if ssh ${SSH_USER}@$PRIMARY_HOST "docker exec erpnext-db mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
        echo "✓ Database is healthy"
    else
        echo "✗ Database is not accessible"
        exit 1
    fi

    echo "=== Pre-deploy checks passed ==="
    exit 0
fi

# Check for multi-server mode (erpnext-db-master)
if ! ssh -o ConnectTimeout=5 ${SSH_USER}@$PRIMARY_HOST "docker ps -q -f name=erpnext-db-master" 2>/dev/null | grep -q .; then
    echo "⚠ No database container found - skipping checks (initial setup)"
    echo "=== Pre-deploy checks skipped (first deployment) ==="
    exit 0
fi

echo "Detected multi-server deployment mode"

# Check if master is accessible
echo "Checking master database..."
if ssh ${SSH_USER}@$PRIMARY_HOST "docker exec erpnext-db-master mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
    echo "✓ Master database is healthy"
else
    echo "✗ Master database is not accessible"
    exit 1
fi

# Check if slave container exists
if ! ssh -o ConnectTimeout=5 ${SSH_USER}@$REPLICA_HOST "docker ps -q -f name=erpnext-db-slave" 2>/dev/null | grep -q .; then
    echo "⚠ Slave database container not found - skipping slave checks"
    echo "=== Pre-deploy checks passed ==="
    exit 0
fi

# Check if slave is accessible and replicating
echo "Checking slave database..."
if ssh ${SSH_USER}@$REPLICA_HOST "docker exec erpnext-db-slave mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
    echo "✓ Slave database is accessible"

    # Check replication status
    SLAVE_IO=$(ssh ${SSH_USER}@$REPLICA_HOST "docker exec erpnext-db-slave mariadb -u root -p${ROOT_PASS} -N -e \"SHOW SLAVE STATUS\\G\" | grep 'Slave_IO_Running:' | awk '{print \$2}'" 2>/dev/null || echo "No")
    SLAVE_SQL=$(ssh ${SSH_USER}@$REPLICA_HOST "docker exec erpnext-db-slave mariadb -u root -p${ROOT_PASS} -N -e \"SHOW SLAVE STATUS\\G\" | grep 'Slave_SQL_Running:' | awk '{print \$2}'" 2>/dev/null || echo "No")

    if [[ "$SLAVE_IO" == "Yes" && "$SLAVE_SQL" == "Yes" ]]; then
        echo "✓ Replication is running"
    else
        echo "⚠ Replication is not running (IO: $SLAVE_IO, SQL: $SLAVE_SQL)"
        echo "  This is a warning - deployment will continue"
    fi
else
    echo "⚠ Slave database is not accessible - continuing without slave check"
fi

echo "=== Pre-deploy checks passed ==="
