#!/bin/bash
# Post-accessory-boot hook - runs after accessories are started
# Sets up MariaDB master-slave replication automatically

set -e

# Only run for db-master or db-slave accessories
if [[ "$KAMAL_ACCESSORY" != "db-master" && "$KAMAL_ACCESSORY" != "db-slave" ]]; then
    exit 0
fi

# Load secrets
source .kamal/secrets

# Configuration
MASTER_CONTAINER="erpnext-db-master"
SLAVE_CONTAINER="erpnext-db-slave"
REPL_USER="${REPLICATION_USER:-repl_user}"
REPL_PASS="${REPLICATION_PASSWORD}"
ROOT_PASS="${MYSQL_ROOT_PASSWORD}"

# Wait for MariaDB to be ready
wait_for_mysql() {
    local host=$1
    local container=$2
    echo "Waiting for MariaDB on $host ($container) to be ready..."
    for i in {1..30}; do
        if ssh root@$host "docker exec $container mariadb -u root -p${ROOT_PASS} -e 'SELECT 1'" &>/dev/null; then
            echo "MariaDB is ready on $host"
            return 0
        fi
        sleep 2
    done
    echo "Timeout waiting for MariaDB on $host"
    return 1
}

# Setup master
setup_master() {
    local host=$1
    echo "=== Setting up MariaDB Master on $host ==="

    wait_for_mysql "$host" "$MASTER_CONTAINER"

    # Create replication user
    ssh root@$host "docker exec $MASTER_CONTAINER mariadb -u root -p${ROOT_PASS} -e \"
        CREATE USER IF NOT EXISTS '${REPL_USER}'@'%' IDENTIFIED BY '${REPL_PASS}';
        GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO '${REPL_USER}'@'%';
        FLUSH PRIVILEGES;
    \""

    echo "Master setup complete. Replication user created."
}

# Setup slave
setup_slave() {
    local master_host=$1
    local slave_host=$2
    echo "=== Setting up MariaDB Slave on $slave_host ==="

    wait_for_mysql "$slave_host" "$SLAVE_CONTAINER"

    # Get GTID position from master
    GTID_POS=$(ssh root@$master_host "docker exec $MASTER_CONTAINER mariadb -u root -p${ROOT_PASS} -N -e 'SELECT @@gtid_current_pos'" | tr -d '[:space:]')

    if [ -z "$GTID_POS" ]; then
        echo "Warning: No GTID position found, using fresh start"
        GTID_POS=""
    fi

    # Configure slave
    ssh root@$slave_host "docker exec $SLAVE_CONTAINER mariadb -u root -p${ROOT_PASS} -e \"
        STOP SLAVE;
        RESET SLAVE ALL;
        $([ -n "$GTID_POS" ] && echo "SET GLOBAL gtid_slave_pos = '${GTID_POS}';")
        CHANGE MASTER TO
            MASTER_HOST='${master_host}',
            MASTER_USER='${REPL_USER}',
            MASTER_PASSWORD='${REPL_PASS}',
            MASTER_PORT=3306,
            MASTER_USE_GTID=slave_pos,
            MASTER_CONNECT_RETRY=10;
        START SLAVE;
    \""

    # Verify replication status
    sleep 3
    echo "=== Replication Status ==="
    ssh root@$slave_host "docker exec $SLAVE_CONTAINER mariadb -u root -p${ROOT_PASS} -e 'SHOW SLAVE STATUS\G'" | grep -E "Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master|Last_Error" || true

    echo "Slave setup complete."
}

# Main logic based on which accessory was booted
case "$KAMAL_ACCESSORY" in
    db-master)
        # Extract master host from KAMAL_HOSTS
        MASTER_HOST=$(echo "$KAMAL_HOSTS" | tr ',' '\n' | head -1)
        setup_master "$MASTER_HOST"
        ;;
    db-slave)
        # Extract hosts - assumes master is first, slave is second
        MASTER_HOST="${KAMAL_MASTER_HOST:-192.168.0.1}"  # Set via env or default
        SLAVE_HOST=$(echo "$KAMAL_HOSTS" | tr ',' '\n' | head -1)
        setup_slave "$MASTER_HOST" "$SLAVE_HOST"
        ;;
esac

echo "=== Hook completed ==="
