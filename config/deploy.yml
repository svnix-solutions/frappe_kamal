# ERPNext Kamal Deployment Configuration
service: erpnext

# Docker Hub image
image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>

# Server roles configuration
# Hosts are read from environment variables
servers:
  web:
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    options:
      memory: 2g
  worker:
    hosts:
      - <%= ENV.fetch('REPLICA_HOST') %>
    cmd: bench worker --queue short,default,long
    options:
      memory: 1g
  db-primary:
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    proxy: false
  db-replica:
    hosts:
      - <%= ENV.fetch('REPLICA_HOST') %>
    proxy: false

# SSL and proxy configuration
proxy:
  ssl: true
  host: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
  app_port: 8000
  healthcheck:
    path: /api/method/ping
    interval: 30
    timeout: 5

# Docker Hub registry
registry:
  username: <%= ENV.fetch('DOCKER_USERNAME', 'astamia') %>
  password:
    - KAMAL_REGISTRY_PASSWORD

# Builder configuration
builder:
  arch: amd64
  context: .
  dockerfile: Dockerfile
  args:
    FRAPPE_BRANCH: version-15
    FRAPPE_PATH: https://github.com/frappe/frappe
    PYTHON_VERSION: 3.11.6
    NODE_VERSION: 20.19.2
    APPS_JSON_BASE64: <%= Base64.strict_encode64(File.read('apps.json')) rescue '' %>

# Environment variables
env:
  clear:
    # Frappe/ERPNext settings
    FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
    DB_HOST: erpnext-db-master
    DB_PORT: "3306"
    REDIS_CACHE: redis://erpnext-redis-cache:6379
    REDIS_QUEUE: redis://erpnext-redis-queue:6379
    SOCKETIO_PORT: "9000"
  secret:
    - DB_PASSWORD
    - ADMIN_PASSWORD

# SSH configuration
ssh:
  user: <%= ENV.fetch('SSH_USER', 'root') %>

# Persistent storage volumes
volumes:
  - "erpnext_sites:/home/frappe/frappe-bench/sites"
  - "erpnext_logs:/home/frappe/frappe-bench/logs"

# Accessory services
# Using roles to reference servers defined above
accessories:
  # ============================================
  # MariaDB Master (Primary)
  # ============================================
  db-master:
    image: mariadb:10.6
    roles:
      - db-primary
    port: "3306:3306"
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MYSQL_DATABASE: erpnext
        MYSQL_USER: erpnext
        MARIADB_AUTO_UPGRADE: "1"
      secret:
        - MYSQL_ROOT_PASSWORD
        - MYSQL_PASSWORD
    files:
      - config/mariadb/replication/master.cnf:/etc/mysql/conf.d/master.cnf
    directories:
      - data:/var/lib/mysql
    options:
      ulimit: "nofile=262144:262144"

  # ============================================
  # MariaDB Slave (Replica)
  # ============================================
  db-slave:
    image: mariadb:10.6
    roles:
      - db-replica
    port: "3306:3306"
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MARIADB_AUTO_UPGRADE: "1"
      secret:
        - MYSQL_ROOT_PASSWORD
    files:
      - config/mariadb/replication/slave.cnf:/etc/mysql/conf.d/slave.cnf
    directories:
      - data:/var/lib/mysql
    options:
      ulimit: "nofile=262144:262144"

  # ============================================
  # Database Backup Service
  # ============================================
  db-backup:
    image: fradelg/mysql-cron-backup:latest
    roles:
      - db-primary
    env:
      clear:
        MYSQL_HOST: erpnext-db-master
        MYSQL_PORT: "3306"
        MYSQL_USER: root
        MAX_BACKUPS: "7"
        INIT_BACKUP: "1"
        CRON_TIME: "0 2 * * *"
        GZIP_LEVEL: "9"
      secret:
        - MYSQL_PASS
    directories:
      - backups:/backup

  # ============================================
  # Redis Cache
  # ============================================
  redis-cache:
    image: redis:7-alpine
    roles:
      - db-primary
    port: "6379:6379"
    cmd: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    directories:
      - cache-data:/data

  # ============================================
  # Redis Queue
  # ============================================
  redis-queue:
    image: redis:7-alpine
    roles:
      - db-primary
    port: "6380:6379"
    cmd: redis-server --appendonly yes
    directories:
      - queue-data:/data

# Deployment aliases
aliases:
  shell: app exec --interactive --reuse "bash"
  console: app exec --interactive --reuse "bench console"
  logs: app logs -f
  db-shell: accessory exec db-master "mariadb -u root -p"
  db-backup-now: accessory exec db-backup "/backup.sh"
