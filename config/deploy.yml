# ERPNext Kamal Deployment Configuration - Multi-Server with Replication
#
# Architecture:
#   Server 1 (Primary): nginx, gunicorn, socketio, db-master, redis
#   Server 2 (Replica): worker, db-slave
#
#   nginx (web) -> gunicorn (backend API)
#                -> socketio (WebSocket)
#   worker (background jobs on replica)
#
service: erpnext

# ERPNext image (includes nginx, gunicorn, node)
image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>

# Server roles configuration
servers:
  web:
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    cmd: nginx-entrypoint.sh
    options:
      memory: 256m
  db-primary:
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    proxy: false
  db-replica:
    hosts:
      - <%= ENV.fetch('REPLICA_HOST') %>
    proxy: false

# SSL and proxy configuration
proxy:
  ssl: true
  host: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
  app_port: 8080
  healthcheck:
    path: /up
    interval: 3
    timeout: 5

# Docker Hub registry
registry:
  username: <%= ENV.fetch('DOCKER_USERNAME', 'astamia') %>
  password:
    - KAMAL_REGISTRY_PASSWORD

# Builder configuration for ERPNext image
builder:
  arch: amd64
  context: .
  dockerfile: Dockerfile
  args:
    FRAPPE_BRANCH: version-15
    FRAPPE_PATH: https://github.com/frappe/frappe
    PYTHON_VERSION: 3.11.6
    NODE_VERSION: 20.19.2
    APPS_JSON_BASE64: <%= Base64.strict_encode64(File.read('apps.json')) rescue '' %>

# Environment variables for nginx
env:
  clear:
    BACKEND: erpnext-gunicorn:8000
    SOCKETIO: erpnext-socketio:9000
    FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
    UPSTREAM_REAL_IP_ADDRESS: "127.0.0.1"
    UPSTREAM_REAL_IP_HEADER: "X-Forwarded-For"
    UPSTREAM_REAL_IP_RECURSIVE: "off"
    PROXY_READ_TIMEOUT: "120"
    CLIENT_MAX_BODY_SIZE: "50m"

# SSH configuration
ssh:
  user: <%= ENV.fetch('SSH_USER', 'root') %>

# Volumes for nginx (needs access to sites for static files)
volumes:
  - "erpnext_sites:/home/frappe/frappe-bench/sites:ro"

# Accessory services
accessories:
  # ============================================
  # Configure Bench (runs before other services)
  # ============================================
  configure:
    image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>
    roles:
      - db-primary
    cmd: bash /scripts/configure.sh
    env:
      clear:
        FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
        DB_HOST: erpnext-db-master
        DB_PORT: "3306"
        REDIS_CACHE: redis://erpnext-redis-cache:6379
        REDIS_QUEUE: redis://erpnext-redis-queue:6379
        SOCKETIO_PORT: "9000"
      secret:
        - MYSQL_ROOT_PASSWORD
        - ADMIN_PASSWORD
    files:
      - config/frappe/configure.sh:/scripts/configure.sh
    volumes:
      - "erpnext_sites:/home/frappe/frappe-bench/sites"
      - "erpnext_logs:/home/frappe/frappe-bench/logs"

  # ============================================
  # Gunicorn (Backend API Server)
  # ============================================
  gunicorn:
    image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>
    roles:
      - db-primary
    port: "8000:8000"
    env:
      clear:
        FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
        DB_HOST: erpnext-db-master
        DB_PORT: "3306"
        REDIS_CACHE: redis://erpnext-redis-cache:6379
        REDIS_QUEUE: redis://erpnext-redis-queue:6379
        SOCKETIO_PORT: "9000"
      secret:
        - MYSQL_ROOT_PASSWORD
        - ADMIN_PASSWORD
    volumes:
      - "erpnext_sites:/home/frappe/frappe-bench/sites"
      - "erpnext_logs:/home/frappe/frappe-bench/logs"
    options:
      memory: 2g

  # ============================================
  # SocketIO (WebSocket Server)
  # ============================================
  socketio:
    image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>
    roles:
      - db-primary
    port: "9000:9000"
    cmd: node /home/frappe/frappe-bench/apps/frappe/socketio.js
    env:
      clear:
        FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
        REDIS_QUEUE: redis://erpnext-redis-queue:6379
    volumes:
      - "erpnext_sites:/home/frappe/frappe-bench/sites"
      - "erpnext_logs:/home/frappe/frappe-bench/logs"
    options:
      memory: 512m

  # ============================================
  # Worker (Background Jobs - on Replica)
  # ============================================
  worker:
    image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>
    roles:
      - db-replica
    cmd: bench worker --queue short,default,long
    env:
      clear:
        FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
        DB_HOST: erpnext-db-master
        DB_PORT: "3306"
        REDIS_CACHE: redis://erpnext-redis-cache:6379
        REDIS_QUEUE: redis://erpnext-redis-queue:6379
      secret:
        - MYSQL_ROOT_PASSWORD
        - ADMIN_PASSWORD
    volumes:
      - "erpnext_sites:/home/frappe/frappe-bench/sites"
      - "erpnext_logs:/home/frappe/frappe-bench/logs"
    options:
      memory: 1g

  # ============================================
  # MariaDB Master (Primary)
  # ============================================
  db-master:
    image: mariadb:10.6
    roles:
      - db-primary
    port: "3306:3306"
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MARIADB_AUTO_UPGRADE: "1"
      secret:
        - MYSQL_ROOT_PASSWORD
    files:
      - config/mariadb/replication/master.cnf:/etc/mysql/conf.d/master.cnf
    directories:
      - data:/var/lib/mysql
    options:
      ulimit: "nofile=262144:262144"

  # ============================================
  # MariaDB Slave (Replica)
  # ============================================
  db-slave:
    image: mariadb:10.6
    roles:
      - db-replica
    port: "3306:3306"
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MARIADB_AUTO_UPGRADE: "1"
      secret:
        - MYSQL_ROOT_PASSWORD
    files:
      - config/mariadb/replication/slave.cnf:/etc/mysql/conf.d/slave.cnf
    directories:
      - data:/var/lib/mysql
    options:
      ulimit: "nofile=262144:262144"

  # ============================================
  # Database Backup Service
  # ============================================
  db-backup:
    image: fradelg/mysql-cron-backup:latest
    roles:
      - db-primary
    env:
      clear:
        MYSQL_HOST: erpnext-db-master
        MYSQL_PORT: "3306"
        MYSQL_USER: root
        MAX_BACKUPS: "7"
        INIT_BACKUP: "1"
        CRON_TIME: "0 2 * * *"
        GZIP_LEVEL: "9"
      secret:
        - MYSQL_PASS
    directories:
      - backups:/backup

  # ============================================
  # Redis Cache
  # ============================================
  redis-cache:
    image: redis:7-alpine
    roles:
      - db-primary
    port: "6379:6379"
    cmd: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    directories:
      - cache-data:/data

  # ============================================
  # Redis Queue
  # ============================================
  redis-queue:
    image: redis:7-alpine
    roles:
      - db-primary
    port: "6380:6379"
    cmd: redis-server --appendonly yes
    directories:
      - queue-data:/data

# Deployment aliases
aliases:
  shell: accessory exec gunicorn "bash"
  console: accessory exec gunicorn "bench console"
  logs: app logs -f
  db-shell: accessory exec db-master "mariadb -u root -p"
  db-backup-now: accessory exec db-backup "/backup.sh"
