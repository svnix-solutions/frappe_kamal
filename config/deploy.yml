# ERPNext Kamal Deployment Configuration
#
# Architecture:
#   web container (supervisor) -> nginx (port 8080)
#                              -> gunicorn (port 8000)
#                              -> socketio (port 9000)
#   worker accessory (background jobs)
#
service: erpnext

# ERPNext image (includes nginx, gunicorn, node, supervisor)
image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>

# Single server configuration - runs supervisor with nginx+gunicorn+socketio
servers:
  web:
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    options:
      memory: 2g

# Proxy configuration (SSL disabled for testing)
proxy:
  ssl: false
  host: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
  app_port: 8080
  healthcheck:
    path: /up
    interval: 3
    timeout: 5

# Docker Hub registry
registry:
  username: <%= ENV.fetch('DOCKER_USERNAME', 'astamia') %>
  password:
    - KAMAL_REGISTRY_PASSWORD

# Builder configuration for ERPNext image
builder:
  arch: amd64
  context: .
  dockerfile: Dockerfile
  args:
    FRAPPE_BRANCH: version-15
    FRAPPE_PATH: https://github.com/frappe/frappe
    PYTHON_VERSION: 3.11.6
    NODE_VERSION: 20.19.2
    APPS_JSON_BASE64: <%= Base64.strict_encode64(File.read('apps.json')) rescue '' %>

# Environment variables for web container
env:
  clear:
    FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
    DB_HOST: erpnext-db
    DB_PORT: "3306"
    REDIS_CACHE: redis://erpnext-redis-cache:6379
    REDIS_QUEUE: redis://erpnext-redis-queue:6379
    SOCKETIO_PORT: "9000"
  secret:
    - MYSQL_ROOT_PASSWORD
    - ADMIN_PASSWORD

# SSH configuration
ssh:
  user: <%= ENV.fetch('SSH_USER', 'root') %>

# Volumes for web container (sites and logs)
volumes:
  - "$HOME/erpnext/sites:/home/frappe/frappe-bench/sites"
  - "$HOME/erpnext/logs:/home/frappe/frappe-bench/logs"

# Accessory services
accessories:
  # ============================================
  # Worker (Background Jobs)
  # ============================================
  worker:
    image: <%= ENV.fetch('DOCKER_IMAGE', 'astamia/erpnext') %>
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    cmd: bench worker --queue short,default,long
    env:
      clear:
        FRAPPE_SITE_NAME_HEADER: <%= ENV.fetch('ERPNEXT_DOMAIN', 'erp.example.com') %>
        DB_HOST: erpnext-db
        DB_PORT: "3306"
        REDIS_CACHE: redis://erpnext-redis-cache:6379
        REDIS_QUEUE: redis://erpnext-redis-queue:6379
        SOCKETIO_PORT: "9000"
      secret:
        - MYSQL_ROOT_PASSWORD
        - ADMIN_PASSWORD
    volumes:
      - "$HOME/erpnext/sites:/home/frappe/frappe-bench/sites"
      - "$HOME/erpnext/logs:/home/frappe/frappe-bench/logs"
    options:
      memory: 1g

  # ============================================
  # MariaDB (Single Instance)
  # ============================================
  db:
    image: mariadb:10.6
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    port: "3306:3306"
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MARIADB_AUTO_UPGRADE: "1"
      secret:
        - MYSQL_ROOT_PASSWORD
    files:
      - config/mariadb/mariadb.cnf:/etc/mysql/conf.d/custom.cnf
    directories:
      - data:/var/lib/mysql
    options:
      ulimit: "nofile=262144:262144"

  # ============================================
  # Database Backup Service
  # ============================================
  db-backup:
    image: fradelg/mysql-cron-backup:latest
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    env:
      clear:
        MYSQL_HOST: erpnext-db
        MYSQL_PORT: "3306"
        MYSQL_USER: root
        MAX_BACKUPS: "7"
        INIT_BACKUP: "1"
        CRON_TIME: "0 2 * * *"
        GZIP_LEVEL: "9"
      secret:
        - MYSQL_PASS
    directories:
      - backups:/backup

  # ============================================
  # Redis Cache
  # ============================================
  redis-cache:
    image: redis:7-alpine
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    port: "6379:6379"
    cmd: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    directories:
      - cache-data:/data

  # ============================================
  # Redis Queue
  # ============================================
  redis-queue:
    image: redis:7-alpine
    hosts:
      - <%= ENV.fetch('PRIMARY_HOST') %>
    port: "6380:6379"
    cmd: redis-server --appendonly yes
    directories:
      - queue-data:/data

# Deployment aliases
aliases:
  shell: app exec "bash"
  console: app exec "bench console"
  logs: app logs -f
  db-shell: accessory exec db "mariadb -u root -p"
  db-backup-now: accessory exec db-backup "/backup.sh"
  # Note: Run configure manually with: kamal app exec "configure.sh" --user root
